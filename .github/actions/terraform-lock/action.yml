# .github/actions/terraform-lock/action.yml
name: 'Terraform Lock Handler'
description: 'Handles Terraform state locks - check, wait, unlock'
author: 'Your Team'

inputs:
  command:
    description: 'Command: check-lock, wait-for-lock, force-unlock'
    required: true
  state-bucket:
    description: 'S3 bucket for state'
    required: true
  state-key:
    description: 'S3 key for state file'
    required: true
  lock-table:
    description: 'DynamoDB table for locks'
    required: true
  aws-region:
    description: 'AWS region'
    required: true
  max-wait-minutes:
    description: 'Max wait time for lock (minutes)'
    required: false
    default: '10'
  force-after-minutes:
    description: 'Force unlock if lock older than X minutes'
    required: false
    default: '30'

outputs:
  is-locked:
    description: 'Is state currently locked'
    value: ${{ steps.check.outputs.is-locked }}
  lock-id:
    description: 'Lock ID if locked'
    value: ${{ steps.check.outputs.lock-id }}
  lock-age:
    description: 'Lock age in minutes'
    value: ${{ steps.check.outputs.lock-age }}

runs:
  using: 'composite'
  steps:
    - name: Check Lock
      id: check
      shell: bash
      run: |
        LOCK_ID="${{ inputs.state-bucket }}/${{ inputs.state-key }}-md5"
        
        echo "üîç Checking lock status..."
        echo "Lock ID: $LOCK_ID"
        
        LOCK_INFO=$(aws dynamodb get-item \
          --table-name "${{ inputs.lock-table }}" \
          --key "{\"LockID\": {\"S\": \"$LOCK_ID\"}}" \
          --region "${{ inputs.aws-region }}" \
          2>/dev/null || echo "{}")
        
        if echo "$LOCK_INFO" | jq -e '.Item' > /dev/null; then
          echo "is-locked=true" >> $GITHUB_OUTPUT
          
          # Parse lock info
          INFO=$(echo "$LOCK_INFO" | jq -r '.Item.Info.S')
          ID=$(echo "$INFO" | jq -r '.ID // "unknown"')
          WHO=$(echo "$INFO" | jq -r '.Who // "unknown"')
          CREATED=$(echo "$INFO" | jq -r '.Created // "unknown"')
          
          echo "lock-id=$ID" >> $GITHUB_OUTPUT
          
          # Calculate age
          if [[ "$CREATED" != "unknown" ]]; then
            CREATED_TS=$(date -d "$CREATED" +%s 2>/dev/null || echo 0)
            NOW_TS=$(date +%s)
            AGE_MINUTES=$(( (NOW_TS - CREATED_TS) / 60 ))
            echo "lock-age=$AGE_MINUTES" >> $GITHUB_OUTPUT
            
            echo "üîí State is locked"
            echo "   Locked by: $WHO"
            echo "   Lock ID: $ID"
            echo "   Created: $CREATED"
            echo "   Age: $AGE_MINUTES minutes"
          else
            echo "lock-age=unknown" >> $GITHUB_OUTPUT
            echo "üîí State is locked (unknown age)"
          fi
        else
          echo "is-locked=false" >> $GITHUB_OUTPUT
          echo "lock-age=0" >> $GITHUB_OUTPUT
          echo "‚úÖ State is not locked"
        fi

    - name: Force Unlock Old Lock
      if: inputs.command == 'force-unlock' 
      shell: bash
      run: |
        echo "‚ö†Ô∏è Lock is ${{ steps.check.outputs.lock-age }} minutes old (threshold: ${{ inputs.force-after-minutes }} minutes)"
        echo "üîì Auto-removing stale lock..."
        
        LOCK_ID="${{ inputs.state-bucket }}/${{ inputs.state-key }}-md5"
        aws dynamodb delete-item \
          --table-name "${{ inputs.lock-table }}" \
          --key "{\"LockID\": {\"S\": \"$LOCK_ID\"}}" \
          --region "${{ inputs.aws-region }}" || true
        
        echo "‚úÖ Stale lock removed"

    - name: Wait for Lock
      if: |
        inputs.command == 'wait-for-lock' && 
        steps.check.outputs.is-locked == 'true'
      shell: bash
      run: |
        MAX_WAIT=$(( ${{ inputs.max-wait-minutes }} * 60 ))
        ELAPSED=0
        
        echo "‚è≥ Waiting up to ${{ inputs.max-wait-minutes }} minutes for lock release..."
        echo "   Current lock held by: ${{ steps.check.outputs.lock-who }}"
        
        while [[ $ELAPSED -lt $MAX_WAIT ]]; do
          sleep 10
          ELAPSED=$((ELAPSED + 10))
          
          # Check if still locked
          LOCK_ID="${{ inputs.state-bucket }}/${{ inputs.state-key }}-md5"
          LOCK_CHECK=$(aws dynamodb get-item \
            --table-name "${{ inputs.lock-table }}" \
            --key "{\"LockID\": {\"S\": \"$LOCK_ID\"}}" \
            --region "${{ inputs.aws-region }}" \
            2>/dev/null || echo "{}")
          
          if ! echo "$LOCK_CHECK" | jq -e '.Item' > /dev/null; then
            echo "‚úÖ Lock released after $ELAPSED seconds!"
            exit 0
          fi
          
          echo "   Still waiting... ($ELAPSED/$MAX_WAIT seconds)"
        done
        
        echo "‚ùå Timeout waiting for lock after ${{ inputs.max-wait-minutes }} minutes"
        exit 1